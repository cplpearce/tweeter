/*
 * Client-side JS logic goes here
 * jQuery is already loaded
 * Reminder: Use (and do all your DOM work in) jQuery's document ready function
 */

 /* your tweet html template, any changes here will echo to index.html on generation */
const tweetTemplate = (avatar = '/images/avatars/001-man.png', name = 'Error', handle = '@error', tweet = 'error', date = Date.now()) => {
  return `
  <article class="tweet-container">
  <header>
    <img class="tweet-l" src="${avatar}" width="50" height="50">
    <span class="tweet-l">${name}</span>
    <span class="tweet-r handle">${handle}</span>
  </header>
  <main>
    ${tweet}
  </main>
  <footer>
    <span class="tweet-l">${new Date(date - Date.now()).getDay()} Days Ago</span>
    <div class="tweet-r">
      <img class="icon" src="/images/icons/bxs-flag-alt.svg">
      <img class="icon" src="/images/icons/bx-repost.svg">
      <img class="icon" src="/images/icons/bxs-heart.svg">
    </div>
  </footer>
  </article>
  `
};

const renderTweetOnFeed = (data, avatarKey = data.user.avatars, nameKey = data.user.name, handleKey = data.user.handle, textKey = data.content.text, dateKey = data.created_at) => {
  $('#tweet-feed').append(tweetTemplate(
    avatarKey,
    nameKey,
    handleKey,
    textKey,
    dateKey
    )
  );
}

const loadTweets = () => {
  $.ajax('/tweets', 'GET')
      .then((response) => {
        Object.keys(response).map((tweet) => renderTweetOnFeed(response[tweet]));
  });
}

/* on document ready, fetch the previous tweets from your source
   please note, tweets are generated by "tweetTemplate" defined above. */
$( document ).ready(() => {

  // submit a new tweet
  $( '#new-tweet-form' ).submit((event) => {
    event.preventDefault();
    // sanitize user tweet data
    if (!$( '#tweet-text' ).val()) {toast('You can\'t post an empty tweet!')}
    else if ($( '#tweet-text' ).val().length > 140) {toast('Your tweet can\'t be over 140 characters!')}
    else {$.post('/tweets', $( '#new-tweet-form' ).serialize()) && $( '#tweet-text' ).val('') && toast('Tweeted Successfully!', true)};
  });

  // render all the tweets to our page
  loadTweets();
});
